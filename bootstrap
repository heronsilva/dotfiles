#!/bin/bash

set -e

if [ -f "scripts/utils.sh" ]; then
    . scripts/utils.sh
else
    # Fallback definitions if utils.sh is not available yet (e.g. initial bootstrap)
    log_info() { echo -e "\033[0;34m[INFO]\033[0m $1"; }
    log_success() { echo -e "\033[0;32m[SUCCESS]\033[0m $1"; }
    log_warning() { echo -e "\033[1;33m[WARNING]\033[0m $1"; }
    log_error() { echo -e "\033[0;31m[ERROR]\033[0m $1"; }

    command_exists() { command -v "$1" >/dev/null 2>&1; }

    ask_confirm() {
        local prompt="$1"
        if [ "$DOTFILES_AUTO_INSTALL" = "1" ] || [ ! -t 0 ]; then return 0; fi
        while true; do
            read -p "$prompt [y/n]: " yn
            case $yn in [Yy]*) return 0 ;; [Nn]*) return 1 ;; *) echo "Please answer yes or no." ;; esac
        done
    }

    run() {
        if [ "$(id -u)" -ne 0 ] && command_exists sudo; then
            sudo "$@"
        else
            "$@"
        fi
    }

    detect_os() {
        if [ "$(uname -s)" = "Darwin" ]; then
            echo "macos"
        elif [ -f /etc/os-release ]; then
            . /etc/os-release
            echo "$ID"
        else echo "linux"; fi
    }
fi

DOTFILES_REPO="${REPO_URL:-https://github.com/heronsilva/dotfiles.git}"
DOTFILES_DIR="$HOME/Workbench/dotfiles"

install_prerequisite() {
    local name="$1"
    local os="$2"

    if command_exists "$name"; then
        return 0
    fi

    case "$name" in
    "sudo")
        log_info "Installing sudo..."
        if [ "$(id -u)" -ne 0 ]; then
            log_error "sudo is required but not installed, and you are not root. Please install sudo or run as root."
            exit 1
        fi
        case "$os" in
        macos) ;; # macOS always has sudo
        ubuntu | debian | kali | neon | pop | pureos | raspbian) apt-get update && apt-get install -y sudo ;;
        fedora | centos) dnf install -y sudo || yum install -y sudo ;;
        arch | manjaro) pacman -Sy --noconfirm --needed sudo ;;
        opensuse*) zypper install -y sudo ;;
        alpine) apk add --no-cache sudo ;;
        *)
            if command_exists apt-get; then
                apt-get update && apt-get install -y sudo
            elif command_exists dnf; then
                dnf install -y sudo
            elif command_exists pacman; then
                pacman -Sy --noconfirm --needed sudo
            elif command_exists zypper; then
                zypper install -y sudo
            elif command_exists apk; then
                apk add --no-cache sudo
            fi
            ;;
        esac
        ;;
    "git")
        log_info "Installing git..."
        case "$os" in
        macos)
            if ! command_exists brew; then
                /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
                if [ -x /opt/homebrew/bin/brew ]; then eval "$(/opt/homebrew/bin/brew shellenv)"; fi
            fi
            brew install git
            ;;
        *)
            case "$os" in
            ubuntu | debian | kali | neon | pop | pureos | raspbian) run apt-get update && run apt-get install -y git ;;
            fedora | centos) run dnf install -y git || run yum install -y git ;;
            arch | manjaro) run pacman -Sy --noconfirm --needed git ;;
            opensuse*) run zypper install -y git ;;
            alpine) run apk add --no-cache git ;;
            *)
                if command_exists apt-get; then
                    run apt-get update && run apt-get install -y git
                elif command_exists dnf; then
                    run dnf install -y git
                elif command_exists pacman; then
                    run pacman -Sy --noconfirm --needed git
                elif command_exists zypper; then
                    run zypper install -y git
                elif command_exists apk; then
                    run apk add --no-cache git
                fi
                ;;
            esac
            ;;
        esac
        ;;
    esac
}

setup_repository() {
    log_info "Setting up dotfiles repository..."

    mkdir -p "$HOME/Workbench"

    if [ -d "$DOTFILES_DIR" ]; then
        log_info "Dotfiles directory exists, updating..."
        cd "$DOTFILES_DIR"
        git pull origin main || git pull origin master || true
    else
        log_info "Cloning dotfiles repository..."
        git clone "$DOTFILES_REPO" "$DOTFILES_DIR"
        cd "$DOTFILES_DIR"
    fi

    log_success "Repository setup complete"
}

run_installation() {
    log_info "Running dotfiles installation..."

    cd "$DOTFILES_DIR"
    chmod +x ./install
    ./install

    log_success "Dotfiles installation complete"
}

apply_macos_defaults() {
    log_info "Applying macOS system defaults..."

    if [ -f "$DOTFILES_DIR/defaults/macos.sh" ]; then
        sh "$DOTFILES_DIR/defaults/macos.sh"
    else
        log_warning "macOS defaults script not found, skipping..."
    fi
}

main() {
    log_info "Starting dotfiles installation..."
    log_info "Repository: $DOTFILES_REPO"
    log_info "Installation directory: $DOTFILES_DIR"

    if ! ask_confirm "This script will install dotfiles and all dependencies. Continue?"; then
        log_error "Installation canceled"
        exit 1
    fi

    export DOTFILES_AUTO_INSTALL=1

    local os=$(detect_os)
    log_info "Detected OS: $os"

    # Ensure essential prerequisites are installed
    install_prerequisite "sudo" "$os"
    install_prerequisite "git" "$os"

    setup_repository
    run_installation

    if [ "$os" = "macos" ]; then
        apply_macos_defaults
    fi

    log_success "Dotfiles installation completed successfully!"
    log_info "Restart your shell or run 'source ~/.zshrc' to apply changes"
}

main "$@"
