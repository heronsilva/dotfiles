#!/bin/bash

set -e

if [ -f "scripts/utils.sh" ]; then
    source scripts/utils.sh
fi

DOTFILES_REPO="${REPO_URL:-https://github.com/heronsilva/dotfiles.git}"
DOTFILES_DIR="$HOME/Workbench/dotfiles"

install_prerequisite() {
    local name="$1"
    local os="$2"

    case "$name" in
        "git")
            log_info "Installing git..."
            case "$os" in
                macos)
                    if ! command_exists brew; then
                        /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
                        if [ -x /opt/homebrew/bin/brew ]; then eval "$(/opt/homebrew/bin/brew shellenv)"; fi
                    fi
                    brew install git
                    ;;
                *)
                    case "$os" in
                        ubuntu | debian | kali | neon | pop | pureos | raspbian) run apt-get update && run apt-get install -y git ;;
                        fedora | centos) run dnf install -y git || run yum install -y git ;;
                        arch | manjaro) run pacman -Sy --noconfirm --needed git ;;
                        opensuse*) run zypper install -y git ;;
                        alpine) run apk add --no-cache git ;;
                        *)
                            if command_exists apt-get; then
                                run apt-get update && run apt-get install -y git
                            elif command_exists dnf; then
                                run dnf install -y git
                            elif command_exists pacman; then
                                run pacman -Sy --noconfirm --needed git
                            elif command_exists zypper; then
                                run zypper install -y git
                            elif command_exists apk; then
                                run apk add --no-cache git
                            fi
                            ;;
                    esac
                    ;;
            esac
            ;;
    esac
}

setup_repository() {
    log_info "Setting up dotfiles repository..."

    mkdir -p "$HOME/Workbench"

    if [[ -d "$DOTFILES_DIR" ]]; then
        log_info "Dotfiles directory exists, updating..."
        cd "$DOTFILES_DIR"
        git pull origin main || git pull origin master || true
    else
        log_info "Cloning dotfiles repository..."
        git clone "$DOTFILES_REPO" "$DOTFILES_DIR"
        cd "$DOTFILES_DIR"
    fi

    log_success "Repository setup complete"
}

run_installation() {
    log_info "Running dotfiles installation..."

    cd "$DOTFILES_DIR"
    chmod +x ./install
    ./install

    log_success "Dotfiles installation complete"
}

apply_macos_defaults() {
    log_info "Applying macOS system defaults..."

    if [[ -f "$DOTFILES_DIR/defaults/macos.sh" ]]; then
        sh "$DOTFILES_DIR/defaults/macos.sh"
    else
        log_warning "macOS defaults script not found, skipping..."
    fi
}

main() {
    log_info "Starting dotfiles installation..."
    log_info "Repository: $DOTFILES_REPO"
    log_info "Installation directory: $DOTFILES_DIR"

    if ! ask_confirm "This script will install dotfiles and all dependencies. Continue?"; then
        log_error "Installation canceled"
        exit 1
    fi

    export DOTFILES_AUTO_INSTALL=1

    local os=$(detect_os)
    log_info "Detected OS: $os"

    setup_repository
    run_installation

    if [[ $os == "macos" ]]; then
        apply_macos_defaults
    fi

    log_success "Dotfiles installation completed successfully!"
    log_info "Restart your shell or run 'source ~/.zshrc' to apply changes"
}

main "$@"
